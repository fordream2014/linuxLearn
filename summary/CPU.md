
* 理论知识
    + 平均负载 
    
    ```
    含义：单位时间内可运行状态进程和不可中断状态进程的个数，理论上一个cpu核上运行一个进程，不会出现争抢。
    
    可以通过top命令/uptime命令查看系统平均负载的值。
    
    平均负载不能和cpu使用率划等号，平均负载高的原因可能是cpu密集型导致，可能是io密集型导致，也可能是进程较多造成cpu上下文切换导致
    
    平均负载一般超过系统cpu核数的70%，就需要查看问题了
        
    ```
    + cpu使用率
    ```
    时间单位为节拍率
    cpu使用率 = 1 - 空闲时间/全部时间
  
    一般性能工具，会采用截取一段时间的起始状态，做减法操作。
    ```
    
    + cpu上下文切换
    ```
    cpu上下文切换 分为：进程上下文切换，线程上下文切换，中断上下文切换。
    cpu上下文：cpu寄存器和程序计数器，程序计数器用来存储当前程序运行到的指令或者接下来要运行的指令。
    
    进程上下文切换 需要保存用户空间状态、内核堆栈，寄存器等内核空间的状态
    同一进程的线程上下文切换要轻量一些，因为线程之间共享进程的虚拟内存空间，只需要保存线程的私有空间、寄存器等不共享的数据
    中断上下文切换 不涉及进程的用户态，只需要保存内核堆栈 寄存器，用来执行中断处理程序
    
    什么时候进程才会被调度到cpu上运行？
    linux为每个CPU都维护了一个就绪队列，将活跃进程按照优先级和等待CPU的时间排序，然后选择最需要CPU的进程，也就是优先级最高和等待时间最长的进程来运行。
    1 时间片到了
    2 系统资源不足
    3 进程调用sleep函数
    4 有优先级更高的进程运行
    5 发生硬件中断，cpu上的进程会被中断挂起，转而执行内核中的中断服务程序
    
    vmstat指令
    r 就绪队列的长度，正在运行和等待cpu的进程数
    b 不可中断状态的进程数
    cs 每秒上下文切换的次数
    in 每秒中断的次数
        
    如果查看进程的上下文切换，通过pidstat -w 可以查看，包含自愿上下文切换、非自愿上下文切换
    
    自愿上下文切换 一般是由于资源紧缺，导致进程主动挂起。切换变多，说明进程都在等待资源，有可能I/O等其他问题。
    非自愿上下文切换 时间片到了，系统自动切换。切换变多，说明进程被强制调度，也就是在争抢CPU。
    
    ```
    + 进程状态
    ```
    R 可运行状态或者正在运行的状态
    D 不可中断状态
    Z 僵尸进程
    S 可中断的睡眠状态
    I 空闲状态
    T/t 停止/跟踪状态 SIGSTOP->T SIGCONT->R，或者使用GDB调试->t
    
    不可中断进程状态，保证了进程数据与硬件数据的一致性
    
    io高可以通过命令排查：
        mpstat %iowait
        top wa% 
        dstat 可以查看cpu和io的状态
         
    ```
    +中断
    ```
    硬中断   
    软中断 在linux中，每个cpu都会对应一个软中断内核线程，名字是ksoftirqd/CPU编号。当软中断事件过高时，内核线程也会因为cpu
    使用过高而导致中断处理不及时，进而引发网络收发延迟、调度缓慢等性能问题。因为CPU优先处理中断事件，导致系统缓慢
    ```
* cpu性能指标
    + 平均负载
    + cpu使用率
    + cpu上下文切换

* 命令使用
    ```
    top 
        load  1/5/15分钟平均负载
        Tasks 系统中各类状态的进程数量
        cpu   %Cpu(s): 33.6 us,  4.3 sy,  0.0 ni, 60.3 id,  0.0 wa,  0.0 hi,  1.8 si,  0.0 st
        mem
        各个进程的运行状况
       
    uptime  1/5/15 负载

    mpstat 查看各个cpu性能
    03:46:55 PM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
    03:47:00 PM  all   41.85    0.00    5.07    0.03    0.00    2.02    0.00    0.00    0.00   51.04
    03:47:00 PM    0   37.35    0.00    4.69    0.20    0.00    0.00    0.00    0.00    0.00   57.76
    
    vmstat 查看cpu上下文切换、运行中的进程数目、中断进程数目。
    
    dstat  查看cpu和io性能
    pidstat 查看进程的性能
        -t 可以查看线程
        -u cpu
        -w 上下文
        -d io
    perf top 查看采样事件中，实时显示占用cpu时钟最多的函数或者指令
    perf record/report
        -g 可以开启关系的采样

    sar -n DEV 1  查看网络收发的情况
```